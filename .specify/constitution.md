# Constitution

> Auto-generated by DevKit CLI. DO NOT EDIT MANUALLY.
> Generated: 2026-02-19
> Source: .devkit/arch/invariants.md + .devkit/product/ux_invariants.md + .devkit/arch/decisions/

---

## Technical Invariants

The system MUST guarantee the following:

### I1: Init is idempotent
- **Guarantee**: `devkit init` on an already-initialized directory is a no-op. It never overwrites existing files or directories — only creates missing ones and reports skipped.
- **On violation**: If `existsSync` guard is removed, re-running init resets STATUS.md to `CURRENT_PHASE: research`, losing all phase progress.

### I2: Sequential IDs are strictly monotonic
- **Guarantee**: RFC, INV, and ESC identifiers are assigned by incrementing the highest existing numeric suffix. Deleting a file does not reclaim its number. IDs never collide under single-process usage.
- **On violation**: All three (RFC/INV/ESC) now use max-scan. No file locking — concurrent processes can still collide (acceptable for single-user CLI).

### I3: Phase ordering is a strict linear sequence
- **Guarantee**: The system enforces a fixed five-phase pipeline: research -> product -> arch -> spec -> qa. Advance moves exactly one step. There is no skip and no retreat command.
- **On violation**: Manually editing STATUS.md to an unknown phase now falls back to `research` (validated in getStatus). Gate checker failures are caught with try/catch.

### I4: Gate blocks on any single unsatisfied condition
- **Guarantee**: Phase advancement is blocked if ANY gate condition is unsatisfied. Empty conditions array also blocks (safe-fail default via `length > 0 && every()`).
- **On violation**: Gate checker exceptions are now caught — returns `satisfied: false` with error detail instead of crashing.

### I5: Snapshot diff is content-hash based (SHA-256)
- **Guarantee**: File modification detection uses truncated SHA-256 content hashes (12 hex chars), not filesystem timestamps. Identical content at different times = no diff. Changed content at same second = detected.
- **On violation**: 12-char hash prefix has ~2^48 collision space — negligible in practice. Only .md files are tracked; non-markdown artifacts are invisible to diff.

### I6: Coverage threshold is exactly 2 sources
- **Guarantee**: An invariant is "covered" when mentioned in >=2 distinct sources (test files + contract docs). 1 source = partial. 0 = uncovered. Partial does NOT count toward coverage percentage.
- **On violation**: Keyword matching can false-positive on common words. Invariant "I1: Data Integrity" matches any file containing "data" or "integrity" as substring.

### I7: Resolution mutates files in-place without backup
- **Guarantee**: `resolveRfc` and `resolveInvestigation` rewrite artifact files via line-prefix replacement with direct `writeFileSync`. No backup, no atomic rename, no intermediate file.
- **On violation**: Process kill between read and write corrupts the file (empty or partial). A `STATUS:` field in freeform text will be incorrectly rewritten by the prefix matcher.

### I8: Project state detection is deterministic
- **Guarantee**: `detectProjectState` returns one of four mutually exclusive states in strict priority: initialized > upgrade > brownfield > greenfield. Same filesystem state always produces same result.
- **On violation**: `hasCodeFiles` now has MAX_SCAN_DEPTH=5. Permission errors are silently swallowed (by design — non-readable dirs are skipped).

---

## UX Invariants

The system MUST provide the following user experience guarantees:

### U1: Zero-config start [must]
- **Promise**: `npx devkit init` создаёт рабочий .devkit/ без конфигурации. Автодетект состояния проекта (greenfield/brownfield/upgrade).

### U2: Status at a glance [must]
- **Promise**: `devkit status` показывает текущую фазу, прогресс, blocker'ы и следующий шаг за ≤2 секунды.

### U3: Artifact validation with actionable errors [must]
- **Promise**: `devkit validate` проверяет все артефакты и для каждой ошибки говорит что исправить и где.

### U4: Non-invasive integration [must]
- **Promise**: DevKit CLI не ломает существующий workflow. Все команды идемпотентны. Можно остановиться в любой момент.

### U5: Progressive disclosure [should]
- **Promise**: CLI показывает только релевантную информацию для текущей фазы. ResearchKit команды недоступны когда текущая фаза — SpecKit (если не эскалация).

### U6: Offline-first [should]
- **Promise**: Все core команды (init, status, validate, generate-constitution) работают без интернета.

---

## Active RFCs

- **RFC-001: Add watch mode for validate command** — accepted

---

## Development Guidelines

1. Any deviation from the invariants above requires an RFC through ArchKit
2. New requirements that touch invariants must go through impact analysis
3. Test contracts in QAKit map 1:1 to invariants — every invariant must be testable
4. This file is regenerated when invariants or decisions change — do not edit manually
