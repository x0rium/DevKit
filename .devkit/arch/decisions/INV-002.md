# INV-002: spec-kit integration fundamentally broken: wrong constitution path, wrong command names, missing workflow steps

DATE: 2026-02-19
STATUS: resolved
TRIGGERED_BY: spec-kit integration fundamentally broken: wrong constitution path, wrong command names, missing workflow steps

## Broken Assumption
ASSUMPTION_IN: feasibility.md ("spec-kit — приватный"), unknowns.md ("Constitution generation algorithm")
ASSUMPTION_WAS: spec-kit хранит constitution в `.specify/constitution.md`, использует команды `/constitution`, `/specify`, `/plan`, `/tasks`, `/analyze`, `/implement`
REALITY: spec-kit (v0.0.99, MIT, 70K stars) хранит constitution в `.specify/memory/constitution.md`. Команды имеют префикс `speckit.`: `/speckit.constitution`, `/speckit.specify`, `/speckit.clarify`, `/speckit.plan`, `/speckit.tasks`, `/speckit.analyze`, `/speckit.checklist`, `/speckit.implement`, `/speckit.taskstoissues`. У нас 8 точек разлома.

## Impact
INVARIANTS_AT_RISK: [I1: Init is idempotent, I3: Phase ordering is a strict linear sequence, I4: Gate blocks on any single unsatisfied condition, U3: Artifact validation with actionable errors, U4: Non-invasive integration, U6: Offline-first]
SPECS_AFFECTED: []

## Options

### Option A: spec-kit как обязательный движок L4
DevKit = полный цикл L1-L3 + L5 **вокруг** spec-kit (L4). Не optional, не guardrails — полноценная интеграция:
1. `devkit sync` → пишет в `.specify/memory/constitution.md` (реальный путь spec-kit)
2. Формат конституции: трансформер invariants → spec-kit principles (декларативные MUST/SHOULD, semver)
3. SpecKit SKILL.md делегирует `/speckit.*` командам напрямую (specify, clarify, plan, tasks, analyze, checklist, implement)
4. DevKit event detection (RFC/INV/ESC) прерывает spec-kit workflow и возвращает на нужный уровень
5. `devkit init` проверяет наличие spec-kit, подсказывает установку если нет
6. `devkit gate` на L3→L4 проверяет что spec-kit установлен и constitution сгенерирован в правильном формате
Cost: средний (sync.ts, constitution format, SpecKit SKILL.md, gate.ts, тесты). Нулевой tech debt.

### Option B: Dual-mode constitution
Писать конституцию в оба пути: `.specify/constitution.md` (наш формат) И `.specify/memory/constitution.md` (spec-kit формат). SpecKit SKILL обновить, но сохранить обратную совместимость.
Cost: малый (sync.ts + второй файл). Tech debt: два файла вместо одного. Не решает проблему — L4 всё ещё пустышка без spec-kit.

### Option C: Decouple полностью
Убрать pretend-интеграцию со spec-kit. DevKit работает автономно, `.specify/` не трогает.
Cost: минимальный (удалить sync). Tech debt: L4 бессмысленный, теряем value proposition.

## Decision
CHOSEN: Option A: spec-kit как обязательный движок L4
RATIONALE: DevKit без spec-kit = L4 пустышка. Полная интеграция — единственный вариант с реальной ценностью
DECIDED_BY: developer
DATE_DECIDED: 2026-02-19

## Post-Decision Actions
- [ ] Fix `devkit sync` → write to `.specify/memory/constitution.md`
- [ ] Add constitution transformer: invariants → spec-kit principles format
- [ ] Rewrite SpecKit/SKILL.md with real `/speckit.*` command names and full workflow
- [ ] Add clarify, analyze, checklist steps to SpecKit workflow
- [ ] Update `devkit gate` L3→L4: check spec-kit installed + constitution format
- [ ] Update `devkit init`: check spec-kit, prompt install if missing
- [ ] Sync SKILL.md copies to cli/skills/ and .claude/commands/
- [ ] Update research assumptions (constitution compatibility = invalidated)
- [ ] Regenerate constitution in new format (`devkit generate-constitution && devkit sync`)
- [ ] Run tests, validate, coverage
